<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VERENA — Juntar A1 + A2 (Kappa + CSV)</title>

  <style>
    :root{
      --bg:#070B14; --border: rgba(255,255,255,0.12);
      --text:#EEF2FF; --muted: rgba(238,242,255,.70); --muted2: rgba(238,242,255,.55);
      --accent:#62E7FF; --accent2:#B8A2FF; --ok:#34D399; --warn:#FBBF24; --bad:#FB7185;
      --shadow: 0 18px 50px rgba(0,0,0,0.50); --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      line-height:1.6;
      background:
        radial-gradient(1200px 700px at 12% 10%, rgba(98,231,255,.16), transparent 60%),
        radial-gradient(1200px 700px at 90% 0%, rgba(184,162,255,.18), transparent 55%),
        radial-gradient(1000px 750px at 55% 95%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }
    header{
      position:sticky; top:0; z-index:50;
      background: rgba(7,11,20,0.75);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
    }
    .container{max-width:1120px;margin:0 auto}
    .header-content{display:flex;align-items:center;justify-content:space-between;gap:20px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:14px;flex:1;min-width:240px}
    .logo{
      width:48px;height:48px;border-radius:16px;display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(98,231,255,0.20), rgba(184,162,255,0.16));
      border:1px solid rgba(98,231,255,0.24);
      box-shadow: 0 10px 26px rgba(0,0,0,0.35);
      font-weight:900;font-size:18px;color:var(--accent);
    }
    .brand-text strong{display:block;font-size:15px;font-weight:800}
    .brand-text span{display:block;font-size:12px;color:var(--muted2);font-weight:600}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    nav a{
      text-decoration:none;color:var(--muted);
      padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      font-size:13px;font-weight:700;transition:all .2s ease;
    }
    nav a:hover{color:var(--text);border-color: rgba(98,231,255,0.28);background: rgba(98,231,255,0.08)}
    main{padding: 28px 20px}
    .card{
      border-radius: var(--r);
      border:1px solid var(--border);
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      padding:24px;
      margin-bottom:16px;
    }
    h1{
      margin:0 0 10px;
      font-size: clamp(22px, 3vw, 28px);
      font-weight:900;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; color:transparent;
    }
    h2{margin:0 0 10px;font-size:18px;font-weight:900}
    .muted{color:var(--muted)}
    .tiny{font-size:12.5px;color:var(--muted2)}
    .row{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:980px){ .row{grid-template-columns:1fr 1fr} }
    .file{
      display:block;
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      display:inline-flex;align-items:center;gap:10px;
      padding:12px 14px;border-radius:18px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);color:var(--text);font-weight:900;
      cursor:pointer;transition:all .15s ease;text-decoration:none;
    }
    .btn:hover{border-color: rgba(98,231,255,0.28);background: rgba(255,255,255,0.08);transform: translateY(-1px)}
    .btn.primary{border-color: rgba(98,231,255,0.35);background: linear-gradient(135deg, rgba(98,231,255,0.16), rgba(184,162,255,0.12))}
    .btn.ok{border-color: rgba(52,211,153,0.30);background: rgba(52,211,153,0.10)}
    .btn.danger{border-color: rgba(251,113,133,0.35);background: rgba(251,113,133,0.10)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.05);color: var(--muted);
      font-weight:800;font-size:12.5px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background: rgba(98,231,255,.9)}
    .dot.ok{background: rgba(52,211,153,.95)}
    .dot.warn{background: rgba(251,191,36,.95)}
    .dot.bad{background: rgba(251,113,133,.95)}
    .tableWrap{overflow:auto;border-radius:18px;border:1px solid rgba(255,255,255,.12);margin-top:12px}
    table{width:100%;min-width:980px;border-collapse:separate;border-spacing:0}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.10);vertical-align:top}
    th{background:rgba(255,255,255,.06);color:var(--muted);font-size:12px;text-align:left}
    .metricGrid{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:980px){.metricGrid{grid-template-columns:1fr 1fr 1fr}}
    .metric{border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:14px;background:rgba(255,255,255,.04)}
    .metric .k{font-size:12px;color:var(--muted2);font-weight:800}
    .metric .v{font-size:20px;font-weight:1000;margin-top:4px}
    footer{padding:26px 20px;border-top:1px solid var(--border);background:rgba(7,11,20,0.55);text-align:center;color:var(--muted2);font-size:13px;margin-top:30px}
  </style>
</head>

<body>
<header>
  <div class="container header-content">
    <div class="brand">
      <div class="logo">⇄</div>
      <div class="brand-text">
        <strong>Juntar A1 + A2</strong>
        <span>Calcular Kappa • Exportar CSV</span>
      </div>
    </div>
    <nav>
      <a href="index.html">Início</a>
      <a href="testes.html">Testes</a>
      <a href="a1.html">A1</a>
      <a href="a2.html">A2</a>
      <a href="kappa.html">Kappa</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="card">
    <h1>Juntar resultados (A1 + A2)</h1>
    <p class="muted">
      Carregue <strong>A1.json</strong> e <strong>A2.json</strong>. O sistema faz o pareamento pelo <em>ID do cenário</em>,
      calcula <strong>Cohen’s Kappa</strong> do “Final (0/1)” e exporta um CSV com todos os itens.
    </p>
    <div class="row">
      <div>
        <label class="muted" style="font-weight:900">Arquivo A1.json</label>
        <input class="file" type="file" id="fileA1" accept="application/json" />
      </div>
      <div>
        <label class="muted" style="font-weight:900">Arquivo A2.json</label>
        <input class="file" type="file" id="fileA2" accept="application/json" />
      </div>
    </div>

    <div class="btnRow">
      <button class="btn primary" id="btnMerge">Calcular & Mostrar</button>
      <button class="btn ok" id="btnCSV" disabled>Exportar CSV</button>
      <button class="btn" id="btnJSON" disabled>Baixar Merge.json</button>
      <button class="btn danger" id="btnReset">Reset</button>
    </div>

    <div style="margin-top:10px">
      <span class="pill"><span class="dot ok"></span> Kappa ≥ 0,80 (excelente)</span>
      <span class="pill"><span class="dot warn"></span> 0,60–0,79 (boa)</span>
      <span class="pill"><span class="dot bad"></span> &lt; 0,60 (revisar critérios)</span>
    </div>
    <p class="tiny" style="margin-top:10px">
      Se algum ID existir em A1 e não existir em A2 (ou vice-versa), ele vai aparecer como “faltante”.
    </p>
  </div>

  <div class="card">
    <h2>Métricas</h2>
    <div class="metricGrid" id="metrics">
      <div class="metric"><div class="k">Itens pareados</div><div class="v" id="m_pairs">—</div></div>
      <div class="metric"><div class="k">Acordo observado (Po)</div><div class="v" id="m_po">—</div></div>
      <div class="metric"><div class="k">Cohen’s Kappa</div><div class="v" id="m_kappa">—</div></div>
    </div>
    <p class="tiny" id="m_note" style="margin-top:10px"></p>
  </div>

  <div class="card">
    <h2>Itens combinados</h2>
    <div class="tableWrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>ID</th>
            <th>Final A1</th>
            <th>Final A2</th>
            <th>Acordo?</th>
            <th>Cenário (resumo)</th>
            <th>Obs A1 (C1–C4)</th>
            <th>Obs A2 (C1–C4)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="tiny" style="margin-top:10px">
      Este quadro é para auditoria rápida. O CSV vem completo (com cenário e respostas, se você quiser).
    </p>
  </div>

  <footer>VERENA PIC • Juntar A1 + A2 • Kappa + CSV</footer>
</main>

<script>
  let A1 = null, A2 = null;
  let merged = [];

  function escapeHtml(s){
    return (s??"").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function readJsonFile(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> {
        try{ resolve(JSON.parse(r.result)); }
        catch(e){ reject(e); }
      };
      r.onerror = ()=> reject(new Error("Falha ao ler arquivo"));
      r.readAsText(file);
    });
  }

  function clamp01(v){
    const n = Number(v);
    if (isNaN(n)) return 0;
    return n<=0 ? 0 : 1;
  }

  // Cohen's kappa for binary labels (0/1)
  function kappaBinary(pairs){
    // pairs: [{a:0/1, b:0/1}]
    const n = pairs.length;
    if(n === 0) return {kappa: NaN, po: NaN, pe: NaN, n:0};

    let agree = 0;
    let a1_1 = 0, a1_0 = 0, a2_1 = 0, a2_0 = 0;

    for(const p of pairs){
      const a = clamp01(p.a), b = clamp01(p.b);
      if(a === b) agree++;
      if(a === 1) a1_1++; else a1_0++;
      if(b === 1) a2_1++; else a2_0++;
    }

    const po = agree / n;
    const p1 = a1_1 / n;
    const p0 = a1_0 / n;
    const q1 = a2_1 / n;
    const q0 = a2_0 / n;
    const pe = (p1*q1) + (p0*q0);

    const kappa = (1 - pe) === 0 ? NaN : (po - pe) / (1 - pe);
    return {kappa, po, pe, n};
  }

  function interpretKappa(k){
    if(!isFinite(k)) return {label:"Indefinido", dot:"warn", note:"Kappa não pôde ser calculado (distribuição extrema)."};
    if(k >= 0.80) return {label:"Excelente", dot:"ok", note:"Concordância excelente (>= 0,80)."};
    if(k >= 0.60) return {label:"Boa", dot:"warn", note:"Concordância boa (0,60 a 0,79)."};
    return {label:"Baixa", dot:"bad", note:"Concordância baixa (< 0,60). Sugere revisar critérios e treinamento."};
  }

  function buildMerged(){
    const mapA1 = new Map();
    const mapA2 = new Map();

    (A1.items || []).forEach(x=> mapA1.set((x.scenario_id||"").trim(), x));
    (A2.items || []).forEach(x=> mapA2.set((x.scenario_id||"").trim(), x));

    const ids = new Set([...mapA1.keys(), ...mapA2.keys()]);
    merged = [];

    ids.forEach(id=>{
      if(!id) return;
      const i1 = mapA1.get(id) || null;
      const i2 = mapA2.get(id) || null;

      merged.push({
        scenario_id: id,
        a1: i1,
        a2: i2,
        final_a1: i1 ? clamp01(i1.final) : null,
        final_a2: i2 ? clamp01(i2.final) : null,
        agree_final: (i1 && i2) ? (clamp01(i1.final) === clamp01(i2.final)) : null
      });
    });

    merged.sort((x,y)=> x.scenario_id.localeCompare(y.scenario_id, "pt-BR", {numeric:true}));
  }

  function renderTable(){
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = "";

    merged.forEach(m=>{
      const s = (m.a1?.scenario || m.a2?.scenario || "").slice(0,180);
      const obs1 = m.a1 ? `C1:${m.a1.c1} C2:${m.a1.c2} C3:${m.a1.c3} C4:${m.a1.c4}` : "—";
      const obs2 = m.a2 ? `C1:${m.a2.c1} C2:${m.a2.c2} C3:${m.a2.c3} C4:${m.a2.c4}` : "—";
      const agreeTxt = (m.agree_final===null) ? "FALTANTE" : (m.agree_final ? "SIM" : "NÃO");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(m.scenario_id)}</td>
        <td>${m.final_a1===null ? "—" : m.final_a1}</td>
        <td>${m.final_a2===null ? "—" : m.final_a2}</td>
        <td>${agreeTxt}</td>
        <td>${escapeHtml(s)}</td>
        <td>${escapeHtml(obs1)}</td>
        <td>${escapeHtml(obs2)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function updateMetrics(){
    const pairs = merged
      .filter(m => m.final_a1!==null && m.final_a2!==null)
      .map(m => ({a:m.final_a1, b:m.final_a2}));

    const res = kappaBinary(pairs);
    const k = res.kappa;

    document.getElementById("m_pairs").textContent = String(res.n);
    document.getElementById("m_po").textContent = isFinite(res.po) ? res.po.toFixed(3) : "—";
    document.getElementById("m_kappa").textContent = isFinite(k) ? k.toFixed(3) : "—";

    const interp = interpretKappa(k);
    document.getElementById("m_note").textContent = interp.note;

    // enable exports
    document.getElementById("btnCSV").disabled = merged.length===0;
    document.getElementById("btnJSON").disabled = merged.length===0;
  }

  function csvSafe(v){
    const s = (v??"").toString().replaceAll('"','""');
    return `"${s}"`;
  }

  function download(filename, text, mime="text/plain"){
    const a = document.createElement("a");
    a.href = `data:${mime};charset=utf-8,` + encodeURIComponent(text);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function exportCSV(){
    const headers = [
      "scenario_id",
      "final_a1","final_a2","agree_final",
      "a1_c1","a1_c2","a1_c3","a1_c4",
      "a2_c1","a2_c2","a2_c3","a2_c4",
      "scenario_text"
    ];
    const lines = [headers.join(",")];

    merged.forEach(m=>{
      const scenario = (m.a1?.scenario || m.a2?.scenario || "");
      const row = [
        m.scenario_id,
        m.final_a1, m.final_a2, m.agree_final,
        m.a1?.c1 ?? "", m.a1?.c2 ?? "", m.a1?.c3 ?? "", m.a1?.c4 ?? "",
        m.a2?.c1 ?? "", m.a2?.c2 ?? "", m.a2?.c3 ?? "", m.a2?.c4 ?? "",
        scenario
      ].map(csvSafe);

      lines.push(row.join(","));
    });

    download("verena_pic_merge_a1_a2.csv", lines.join("\n"), "text/csv");
  }

  function exportJSON(){
    const out = {
      generated_at: new Date().toISOString(),
      source: { a1: A1?.evaluator || "A1", a2: A2?.evaluator || "A2" },
      items: merged
    };
    download("Merge.json", JSON.stringify(out, null, 2), "application/json");
  }

  async function handleMerge(){
    const f1 = document.getElementById("fileA1").files[0];
    const f2 = document.getElementById("fileA2").files[0];
    if(!f1 || !f2){
      alert("Selecione os dois arquivos: A1.json e A2.json.");
      return;
    }

    try{
      A1 = await readJsonFile(f1);
      A2 = await readJsonFile(f2);

      if(!A1.items || !A2.items){
        alert("Formato inesperado. Certifique-se de baixar pelo site A1 e A2.");
        return;
      }

      buildMerged();
      renderTable();
      updateMetrics();

      alert("Pronto ✅ Itens combinados e Kappa calculado.");
    }catch(e){
      alert("Erro ao ler JSON: " + (e.message || e));
    }
  }

  function resetAll(){
    A1 = null; A2 = null; merged = [];
    document.getElementById("fileA1").value = "";
    document.getElementById("fileA2").value = "";
    document.querySelector("#tbl tbody").innerHTML = "";
    document.getElementById("m_pairs").textContent = "—";
    document.getElementById("m_po").textContent = "—";
    document.getElementById("m_kappa").textContent = "—";
    document.getElementById("m_note").textContent = "";
    document.getElementById("btnCSV").disabled = true;
    document.getElementById("btnJSON").disabled = true;
  }

  document.getElementById("btnMerge").onclick = handleMerge;
  document.getElementById("btnCSV").onclick = exportCSV;
  document.getElementById("btnJSON").onclick = exportJSON;
  document.getElementById("btnReset").onclick = resetAll;
</script>
</body>
</html>
